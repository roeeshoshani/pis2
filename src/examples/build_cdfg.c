#include "../lib/arch/x86/lift.h"
#include "../lib/cdfg.h"
#include "../lib/cfg.h"
#include "../lib/except.h"
#include "../lib/pis.h"
#include <stdarg.h>
#include <stdio.h>

// define an example trace function
void trace(const char* format, ...) {
    va_list args;
    va_start(args, format);
    vprintf(format, args);
    va_end(args);
}

int main() {
    err_t err = SUCCESS;
    const u8 code[] = {
        0xf3, 0x0f, 0x1e, 0xfa, 0x55, 0x48, 0x89, 0xe5, 0x89, 0x7d, 0xfc, 0x89, 0x75, 0xf8,
        0x8b, 0x45, 0xfc, 0x3b, 0x45, 0xf8, 0x7e, 0x11, 0x8b, 0x45, 0xfc, 0x8d, 0x14, 0xc5,
        0x00, 0x00, 0x00, 0x00, 0x8b, 0x45, 0xf8, 0x01, 0xd0, 0xeb, 0x1d, 0x8b, 0x45, 0xfc,
        0x3b, 0x45, 0xf8, 0x7d, 0x0d, 0x8b, 0x45, 0xf8, 0x8d, 0x14, 0x00, 0x8b, 0x45, 0xfc,
        0x01, 0xd0, 0xeb, 0x08, 0x8b, 0x55, 0xfc, 0x8b, 0x45, 0xf8, 0x01, 0xd0, 0x5d, 0xc3,
    };

    cfg_builder_t cfg_builder = {};
    CHECK_RETHROW(cfg_build(&cfg_builder, pis_lifter_x86_64, code, ARRAY_SIZE(code), 0));

    cdfg_builder_t cdfg_builder = {};
    CHECK_RETHROW(cdfg_build(&cdfg_builder, &cfg_builder.cfg, PIS_ENDIANNESS_LITTLE));

    cdfg_dump_dot(&cdfg_builder.cdfg);

cleanup:
    return err;
}
